/*
Deployment script for Comp440_Project

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "Comp440_Project"
:setvar DefaultFilePrefix "Comp440_Project"
:setvar DefaultDataPath "C:\Users\Daniel\AppData\Local\Microsoft\VisualStudio\SSDT\Comp440_Project"
:setvar DefaultLogPath "C:\Users\Daniel\AppData\Local\Microsoft\VisualStudio\SSDT\Comp440_Project"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ARITHABORT ON,
                CONCAT_NULL_YIELDS_NULL ON,
                CURSOR_DEFAULT LOCAL 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET PAGE_VERIFY NONE,
                DISABLE_BROKER 
            WITH ROLLBACK IMMEDIATE;
    END


GO
ALTER DATABASE [$(DatabaseName)]
    SET TARGET_RECOVERY_TIME = 0 SECONDS 
    WITH ROLLBACK IMMEDIATE;


GO
USE [$(DatabaseName)];


GO
PRINT N'Rename refactoring operation with key 185a8225-c689-4be7-bee7-df9e1f2e9c76 is skipped, element [dbo].[product].[cost] (SqlSimpleColumn) will not be renamed to cost (USD)';


GO
PRINT N'Creating [dbo].[address]...';


GO
CREATE TABLE [dbo].[address] (
    [id]       INT           IDENTITY (1, 1) NOT NULL,
    [street]   VARCHAR (255) NULL,
    [city]     VARCHAR (255) NULL,
    [city_id]  INT           NULL,
    [zip_code] VARCHAR (10)  NULL,
    [state]    VARCHAR (255) NULL,
    CONSTRAINT [PK_address] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating [dbo].[branch]...';


GO
CREATE TABLE [dbo].[branch] (
    [id]               INT      IDENTITY (1, 1) NOT NULL,
    [date_of_creation] DATETIME NULL,
    CONSTRAINT [PK_branch] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating [dbo].[city]...';


GO
CREATE TABLE [dbo].[city] (
    [id]         INT          IDENTITY (1, 1) NOT NULL,
    [city]       VARCHAR (50) NULL,
    [country_id] INT          NULL,
    CONSTRAINT [PK_city] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating [dbo].[country]...';


GO
CREATE TABLE [dbo].[country] (
    [id]      INT          IDENTITY (1, 1) NOT NULL,
    [country] VARCHAR (50) NULL,
    CONSTRAINT [PK_country] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating [dbo].[customer]...';


GO
CREATE TABLE [dbo].[customer] (
    [id]         INT          IDENTITY (1, 1) NOT NULL,
    [first_name] VARCHAR (45) NULL,
    [last_name]  VARCHAR (45) NULL,
    [address_id] INT          NULL,
    [user_id]    INT          NOT NULL,
    CONSTRAINT [PK_customer] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating [dbo].[download]...';


GO
CREATE TABLE [dbo].[download] (
    [customer_id]   INT           NULL,
    [release_id]    INT           NULL,
    [version_id]    INT           NULL,
    [features_id]   INT           NULL,
    [download_link] VARCHAR (100) NOT NULL
);


GO
PRINT N'Creating [dbo].[feature]...';


GO
CREATE TABLE [dbo].[feature] (
    [id]                  INT  IDENTITY (1, 1) NOT NULL,
    [version_id]          INT  NULL,
    [new_features]        TEXT NULL,
    [deprecated_features] TEXT NULL,
    CONSTRAINT [PK_feature] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating [dbo].[product]...';


GO
CREATE TABLE [dbo].[product] (
    [id]          INT           IDENTITY (1, 1) NOT NULL,
    [title]       VARCHAR (255) NULL,
    [description] TEXT          NULL,
    [version_id]  INT           NOT NULL,
    [release_id]  INT           NOT NULL,
    [cost]        FLOAT (53)    NULL,
    CONSTRAINT [PK_product] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating [dbo].[product_category]...';


GO
CREATE TABLE [dbo].[product_category] (
    [product_id] INT          IDENTITY (1, 1) NOT NULL,
    [category]   VARCHAR (25) NULL
);


GO
PRINT N'Creating [dbo].[release]...';


GO
CREATE TABLE [dbo].[release] (
    [id]              INT           IDENTITY (1, 1) NOT NULL,
    [branch_id]       INT           NOT NULL,
    [version_id]      INT           NOT NULL,
    [download_link]   VARCHAR (100) NOT NULL,
    [date_of_release] DATETIME      NULL,
    CONSTRAINT [PK_release] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating [dbo].[user]...';


GO
CREATE TABLE [dbo].[user] (
    [id]       INT          IDENTITY (1, 1) NOT NULL,
    [username] VARCHAR (10) NOT NULL,
    [password] VARCHAR (32) NOT NULL,
    [email]    VARCHAR (50) NOT NULL,
    CONSTRAINT [PK_user] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating [dbo].[version]...';


GO
CREATE TABLE [dbo].[version] (
    [id]              INT          IDENTITY (1, 1) NOT NULL,
    [title]           VARCHAR (25) NOT NULL,
    [date_of_release] DATETIME     NULL,
    CONSTRAINT [PK_version] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating [dbo].[FK_address_cityid]...';


GO
ALTER TABLE [dbo].[address] WITH NOCHECK
    ADD CONSTRAINT [FK_address_cityid] FOREIGN KEY ([city_id]) REFERENCES [dbo].[city] ([id]);


GO
PRINT N'Creating [dbo].[FK_city_countryid]...';


GO
ALTER TABLE [dbo].[city] WITH NOCHECK
    ADD CONSTRAINT [FK_city_countryid] FOREIGN KEY ([country_id]) REFERENCES [dbo].[country] ([id]);


GO
PRINT N'Creating [dbo].[FK_customer_address]...';


GO
ALTER TABLE [dbo].[customer] WITH NOCHECK
    ADD CONSTRAINT [FK_customer_address] FOREIGN KEY ([address_id]) REFERENCES [dbo].[address] ([id]);


GO
PRINT N'Creating [dbo].[FK_customer_userid]...';


GO
ALTER TABLE [dbo].[customer] WITH NOCHECK
    ADD CONSTRAINT [FK_customer_userid] FOREIGN KEY ([user_id]) REFERENCES [dbo].[user] ([id]);


GO
PRINT N'Creating [dbo].[FK_download_customer]...';


GO
ALTER TABLE [dbo].[download] WITH NOCHECK
    ADD CONSTRAINT [FK_download_customer] FOREIGN KEY ([customer_id]) REFERENCES [dbo].[customer] ([id]);


GO
PRINT N'Creating [dbo].[FK_download_features]...';


GO
ALTER TABLE [dbo].[download] WITH NOCHECK
    ADD CONSTRAINT [FK_download_features] FOREIGN KEY ([features_id]) REFERENCES [dbo].[feature] ([id]);


GO
PRINT N'Creating [dbo].[FK_download_release]...';


GO
ALTER TABLE [dbo].[download] WITH NOCHECK
    ADD CONSTRAINT [FK_download_release] FOREIGN KEY ([release_id]) REFERENCES [dbo].[release] ([id]);


GO
PRINT N'Creating [dbo].[FK_download_version]...';


GO
ALTER TABLE [dbo].[download] WITH NOCHECK
    ADD CONSTRAINT [FK_download_version] FOREIGN KEY ([version_id]) REFERENCES [dbo].[version] ([id]);


GO
PRINT N'Creating [dbo].[FK_features_version]...';


GO
ALTER TABLE [dbo].[feature] WITH NOCHECK
    ADD CONSTRAINT [FK_features_version] FOREIGN KEY ([version_id]) REFERENCES [dbo].[version] ([id]);


GO
PRINT N'Creating [dbo].[FK_product_release]...';


GO
ALTER TABLE [dbo].[product] WITH NOCHECK
    ADD CONSTRAINT [FK_product_release] FOREIGN KEY ([release_id]) REFERENCES [dbo].[release] ([id]);


GO
PRINT N'Creating [dbo].[FK_product_version]...';


GO
ALTER TABLE [dbo].[product] WITH NOCHECK
    ADD CONSTRAINT [FK_product_version] FOREIGN KEY ([version_id]) REFERENCES [dbo].[version] ([id]);


GO
PRINT N'Creating [dbo].[FK_product_id]...';


GO
ALTER TABLE [dbo].[product_category] WITH NOCHECK
    ADD CONSTRAINT [FK_product_id] FOREIGN KEY ([product_id]) REFERENCES [dbo].[product] ([id]);


GO
PRINT N'Creating [dbo].[FK_release_branch]...';


GO
ALTER TABLE [dbo].[release] WITH NOCHECK
    ADD CONSTRAINT [FK_release_branch] FOREIGN KEY ([branch_id]) REFERENCES [dbo].[branch] ([id]);


GO
PRINT N'Creating [dbo].[addProduct]...';


GO
CREATE PROCEDURE addProduct
/*
 Procedure that adds a Product 
*/
@title varchar(255) , @description text, @version_id int , @release_id int , @cost float 

AS

INSERT INTO [dbo].[product]
           ([title]
		   ,[description]
           ,[version_id]
           ,[release_id]
		   ,[cost])
     VALUES
           (@title,
		   @description,
		   @version_id,
           @release_id,
		   @cost)
GO
PRINT N'Creating [dbo].[updateVersion]...';


GO
CREATE PROCEDURE [dbo].[updateVersion]
/*
 Procedure that updates the product version. Takes a product title and version id. 
*/
@productTitle varchar(255) = NULL , @version varchar(255) = NULL 

AS

DECLARE @productID int; 

SELECT @productID = id
 FROM [dbo].[product] 
 WHERE title= @productTitle;

	BEGIN
		UPDATE [dbo].[product]
			SET version_id = @version
			WHERE [title] = @productTitle;
	END
GO
-- Refactoring step to update target server with deployed transaction logs

IF OBJECT_ID(N'dbo.__RefactorLog') IS NULL
BEGIN
    CREATE TABLE [dbo].[__RefactorLog] (OperationKey UNIQUEIDENTIFIER NOT NULL PRIMARY KEY)
    EXEC sp_addextendedproperty N'microsoft_database_tools_support', N'refactoring log', N'schema', N'dbo', N'table', N'__RefactorLog'
END
GO
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '185a8225-c689-4be7-bee7-df9e1f2e9c76')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('185a8225-c689-4be7-bee7-df9e1f2e9c76')

GO

GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[address] WITH CHECK CHECK CONSTRAINT [FK_address_cityid];

ALTER TABLE [dbo].[city] WITH CHECK CHECK CONSTRAINT [FK_city_countryid];

ALTER TABLE [dbo].[customer] WITH CHECK CHECK CONSTRAINT [FK_customer_address];

ALTER TABLE [dbo].[customer] WITH CHECK CHECK CONSTRAINT [FK_customer_userid];

ALTER TABLE [dbo].[download] WITH CHECK CHECK CONSTRAINT [FK_download_customer];

ALTER TABLE [dbo].[download] WITH CHECK CHECK CONSTRAINT [FK_download_features];

ALTER TABLE [dbo].[download] WITH CHECK CHECK CONSTRAINT [FK_download_release];

ALTER TABLE [dbo].[download] WITH CHECK CHECK CONSTRAINT [FK_download_version];

ALTER TABLE [dbo].[feature] WITH CHECK CHECK CONSTRAINT [FK_features_version];

ALTER TABLE [dbo].[product] WITH CHECK CHECK CONSTRAINT [FK_product_release];

ALTER TABLE [dbo].[product] WITH CHECK CHECK CONSTRAINT [FK_product_version];

ALTER TABLE [dbo].[product_category] WITH CHECK CHECK CONSTRAINT [FK_product_id];

ALTER TABLE [dbo].[release] WITH CHECK CHECK CONSTRAINT [FK_release_branch];


GO
PRINT N'Update complete.';


GO
